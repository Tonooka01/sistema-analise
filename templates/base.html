<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dashboard Financeiro{% endblock %}</title>

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js and Datalabels Plugin (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- GridStack (CDN) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/8.1.1/gridstack.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/8.1.1/gridstack-all.js"></script>

    <!-- Link para o seu CSS est√°tico -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <style>
        /* Adiciona um estilo b√°sico para o body enquanto o Tailwind carrega */
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
    </style>
</head>
<body class="p-4">
    <div class="container mx-auto"> <!-- Adicionado mx-auto para centralizar container se necess√°rio -->
        {% block content %}{% endblock %}
    </div>

    <!-- Inclui os Modais -->
    {% include 'partials/modals.html' %}

    <script>
document.addEventListener('DOMContentLoaded', () => {
    // Refer√™ncias do NOVO Modal Centralizado
    const adminSettingsModal = document.getElementById('adminSettingsModal');
    const openBtn = document.getElementById('openAdminSettingsModalBtn');
    const closeBtn = document.getElementById('closeAdminSettingsModalBtn');

    // Refer√™ncias dos Elementos INTERNOS (Movidos para o Modal)
    const timeoutInput = document.getElementById('inactivityTimeout');
    const saveButton = document.getElementById('saveTimeoutBtn');
    const statusSpan = document.getElementById('timeoutStatus');

    let timeoutMinutes = 30;
    let lastActivity = Date.now();
    let timeoutId;
    
    // --- Fun√ß√µes de Timer (Mantidas Iguais) ---
    function resetTimer() {
        lastActivity = Date.now();
        clearTimeout(timeoutId);
        timeoutId = setTimeout(checkInactivity, (timeoutMinutes * 60 * 1000) + 1000); 
    }
    // ... (c√≥digo anterior do TimeOut e Modal) ...

    const usersTableBody = document.getElementById('usersTableBody');
    const refreshUsersBtn = document.getElementById('refreshUsersBtn');

    // REFER√äNCIAS NOVAS DO TOGGLE
    const toggleCreateUserBtn = document.getElementById('toggleCreateUserBtn');
    const createUserFormContainer = document.getElementById('createUserFormContainer');

    // L√≥gica do Bot√£o "Novo Usu√°rio"
    toggleCreateUserBtn?.addEventListener('click', () => {
        // Alterna a classe 'hidden'
        createUserFormContainer.classList.toggle('hidden');
        
        // (Opcional) Muda o texto do bot√£o
        if (createUserFormContainer.classList.contains('hidden')) {
            toggleCreateUserBtn.innerHTML = '‚ûï Novo Usu√°rio';
            toggleCreateUserBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            toggleCreateUserBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
        } else {
            toggleCreateUserBtn.innerHTML = '‚ûñ Cancelar';
            toggleCreateUserBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            toggleCreateUserBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
            
            // Foca no campo de usu√°rio para agilizar
            document.getElementById('modalUsername')?.focus();
        }
    });

    // Fun√ß√£o para Carregar Usu√°rios
    async function loadUsers() {
        if (!usersTableBody) return;
        
        try {
            const response = await fetch('/api/admin/users');
            const users = await response.json();
            
            usersTableBody.innerHTML = '';
            
            users.forEach(u => {
                // Define Status Online/Offline
                let statusBadge = u.is_online 
                    ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">‚óè Online</span>`
                    : `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">Offline</span>`;
                
                // Define Bot√£o de A√ß√£o (Ativar/Desativar)
                let actionBtnClass = u.is_active ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-green-100 text-green-700 hover:bg-green-200';
                let actionBtnText = u.is_active ? 'Bloquear üö´' : 'Ativar ‚úÖ';
                let rowOpacity = u.is_active ? '' : 'opacity-60 bg-red-50'; // Deixa meio transparente se bloqueado

                // Link para ver logs espec√≠ficos desse usu√°rio
                let logsLink = `/admin/logs?username=${u.username}`; // (Ainda precisamos ajustar o backend para suportar esse filtro, veja passo extra abaixo)

                const row = `
                    <tr class="border-b border-gray-100 ${rowOpacity}">
                        <td class="py-2 px-3 font-medium text-gray-700">${u.username}</td>
                        <td class="py-2 px-3 text-center">${statusBadge}</td>
                        <td class="py-2 px-3 text-center text-xs text-gray-500">${u.last_seen || 'Nunca'}</td>
                        <td class="py-2 px-3 text-center flex justify-center gap-2">
                            <button onclick="toggleUserStatus(${u.id})" class="px-2 py-1 rounded text-xs font-bold transition ${actionBtnClass}">
                                ${actionBtnText}
                            </button>
                            </td>
                    </tr>
                `;
                usersTableBody.innerHTML += row;
            });
        } catch (e) {
            console.error("Erro ao listar usu√°rios", e);
            usersTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-red-500 py-2">Erro ao carregar.</td></tr>';
        }
    }

    // Fun√ß√£o Global para o bot√£o de Toggle (precisa ser window.toggleUserStatus para funcionar no onclick do HTML gerado)
    window.toggleUserStatus = async function(userId) {
        if(!confirm("Tem certeza que deseja alterar o acesso deste usu√°rio?")) return;
        
        try {
            const res = await fetch('/api/admin/users/toggle', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: userId})
            });
            if(res.ok) {
                loadUsers(); // Recarrega a tabela
            } else {
                const err = await res.json();
                alert("Erro: " + err.error);
            }
        } catch(e) {
            alert("Erro de conex√£o.");
        }
    };

    // Adiciona carregamento ao abrir o modal
    openBtn?.addEventListener('click', () => {
        openModal(); // Sua fun√ß√£o existente
        loadUsers(); // Nova chamada
    });
    
    refreshUsersBtn?.addEventListener('click', loadUsers);

    function checkInactivity() {
        const elapsed = Date.now() - lastActivity;
        const limit = timeoutMinutes * 60 * 1000;

        if (elapsed > limit) {
            console.warn(`Sess√£o expirada por inatividade (${timeoutMinutes} min). Redirecionando para login.`);
            window.location.href = "/logout?reason=inactivity"; 
        }
    }
    // ------------------------------------------

    // 1. Carregar Configura√ß√µes Iniciais
    async function loadSettings() {
        try {
            const response = await fetch('/api/admin/settings');
            if (response.ok) {
                const data = await response.json();
                timeoutMinutes = parseInt(data.timeout_minutes) || 30;
                
                if (timeoutInput) { 
                    timeoutInput.value = timeoutMinutes; // Atualiza o input dentro do modal
                }
            }
        } catch (e) {
            console.error("N√£o foi poss√≠vel carregar tempo de inatividade.", e);
        }
        resetTimer(); 
    }
    
    // 2. Salvar Handler (Evento do Bot√£o Salvar dentro do Modal)
    saveButton?.addEventListener('click', async () => {
        const newTimeout = parseInt(timeoutInput.value);
        if (newTimeout < 5 || newTimeout > 360 || isNaN(newTimeout)) {
            statusSpan.textContent = "Valor deve ser entre 5 e 360 min.";
            statusSpan.classList.remove('text-green-700', 'hidden');
            statusSpan.classList.add('text-red-700');
            return;
        }

        try {
            const response = await fetch('/api/admin/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ timeout: newTimeout })
            });
            if (response.ok) {
                timeoutMinutes = newTimeout;
                resetTimer();
                statusSpan.textContent = `Configura√ß√£o salva (${newTimeout} min)!`;
                statusSpan.classList.remove('text-red-700', 'hidden');
                statusSpan.classList.add('text-green-700');
                setTimeout(() => statusSpan.classList.add('hidden'), 3000);
            }
        } catch (e) {
            statusSpan.textContent = "Erro ao salvar no servidor.";
            statusSpan.classList.remove('text-green-700', 'hidden');
            statusSpan.classList.add('text-red-700');
        }
    });

    // 3. Fun√ß√µes de controle do Modal
    function openModal(e) {
        if (e) e.preventDefault(); 
        if (adminSettingsModal) adminSettingsModal.classList.add('show');
    }
    
    function closeModal() {
        if (adminSettingsModal) adminSettingsModal.classList.remove('show');
        // Limpa o status ao fechar
        statusSpan.classList.add('hidden');
    }

    // Inicializar e Monitorar Eventos do Usu√°rio
    loadSettings();
    openBtn?.addEventListener('click', openModal);
    closeBtn?.addEventListener('click', closeModal);

    // Fechar ao clicar fora e Monitoramento de Atividade (Mantido Igual)
    adminSettingsModal?.addEventListener('click', (e) => { if (e.target === adminSettingsModal) closeModal(); });
    ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'].forEach(event => {
        document.addEventListener(event, resetTimer, true);
    });
});
</script>
    {% include 'partials/modals.html' %}

    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>

</body>
</html>

    <!-- Carrega o JavaScript principal COMO M√ìDULO e usando url_for -->
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>

</body>
</html>

